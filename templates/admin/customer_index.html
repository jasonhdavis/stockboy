{% extends 'admin/master.html' %}
{% block body %}
{{ super() }}

{% if current_user.is_authenticated %}

<!-- Content Header (Page header) -->

<section class="content" id="customer-index">
  <div class="row">
    <!-- Left col -->

    <section class="container">
        <section class="content-header">
                <h1>Customer Loyalty</h1>
                  <small>All customers in date range. Total value in time frame and number of orders. Value calculated including shipping charges minus discounts (if discounts display as negative numbers in shipstation)</small>
          <ol class="breadcrumb">
              <li><a href="./"><i class="fa fa-dashboard"></i>Dashboard</a></li>
              <li class="active">Customers</li>
          </ol>

            <div class="date-picker col-xs-3">
              <form id ='daterangeform' action="{{url_for('customers.CustomerIndex')}}" method="post">
                <label for="daterange"  class="col-2 col-form-label">Select Date Range</label>
                  <input autocomplete="off" class="form-control" type="text" name="daterange" >
                  <input type="submit" name="submit" id="date-submit" value="Go">
              </form>
              <script>
              $(function() {
                $('input[name="daterange"]').daterangepicker({
                  ranges: {
                  'Today': [moment(), moment()],
                  'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                  'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                  'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                  'This Month': [moment().startOf('month'), moment().endOf('month')],
                  'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
              },
                  "alwaysShowCalendars": true,
                  "autoApply": true,
                  "startDate": "{{startdate}}",
                  "endDate": "{{enddate}}"
              }, function(start, end, label) {
                $('#daterangeform submit').click()
              });
              });
              </script>
          </div>

        </section>
        <div class="col-lg-12">

        <section class="content">
          <!-- Small boxes (Stat box) -->
          <div class="row">
            <div class="col-lg-3 col-xs-6">
              <!-- small box -->
              <div class="small-box bg-success">
                <div class="inner">
                  <h3>{{"{:,}".format(top[0])}}</h3>
                  <p>Number of Orders</p>
              </div>
              <div class="icon">
                  <i class="ion ion-pricetag"></i>
              </div>
              <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{"{:,}".format(top[1])}}</h3>

              <p>Unique Customers</p>
          </div>
          <div class="icon">
              <i class="ion ion-stats-bars"></i>
          </div>
          <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
        </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>${{"{:,.2f}".format(top[2])}}</h3>

              <p>Avg Order Value</p>
          </div>
          <div class="icon">
              <i class="ion ion-filing"></i>
          </div>
          <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
        </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-danger">
            <div class="inner">
              <h3>{{"{:,.2f}".format(top[3])}}</h3>

              <p>Repeat Rate</p>
          </div>
          <div class="icon">
              <i class="ion ion-bonfire"></i>
          </div>
          <a href="#" class="small-box-footer">More info <i class="fa fa-arrow-circle-right"></i></a>
        </div>
        </div>
        <!-- ./col -->
        </div>
        <!-- /.row -->
        <!-- Main row -->
        <div class="row">
          <table id="dtBasicExample" class="table table-striped table-bordered table-sm">
            <thead>
                <tr>
                    <th class="th-sm">Customer ID</th>
                    <th class="th-sm">Name</th>
                    <th class="th-sm">Email</th>
                    <th class="th-sm">City</th>
                    <th class="th-sm">State</th>
                    <th class="th-sm"># Orders</th>
                    <th class="th-sm">Customer Value</th>
                </tr>
            </thead>
            <tbody >
              {% for customer_id in customer_dict %}
                <tr>
                    <td><a href="{{customer_id}}">{{customer_id}}</a></td>
                    <td>{{ customer_dict[customer_id]['name'] }}</td>
                    <td>{{ customer_dict[customer_id]['email'] }}</td>
                    <td>{{ customer_dict[customer_id]['city'] }}</td>
                    <td>{{ customer_dict[customer_id]['state'] }}</td>
                    <td>{{ "{:,}".format(customer_dict[customer_id]['num_orders']) }}</td>
                    <td>${{ "{:,.2f}".format(customer_dict[customer_id]['customer_value']) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
          </div>

    </section>
    <!-- /.Left col -->

  </div>
  <!-- /.row (main row) -->
</div>
</section>
<!-- /.content -->
{% else %}

<center>
  <section class="content" style="color: white">
    <div class="col-sm-12">
      <h1>Flask-Admin example</h1>
      <p class="lead">
        Authentication
      </p>
      <p>
        This example shows how you can use Flask-Admin in an admin template, <br> here I used AdminLTE and <a href="https://pythonhosted.org/Flask-Security/index.html" target="_blank">Flask-Security</a> for authentication.
      </p>
      {% if not current_user.is_authenticated %}

      <p>You can register as a regular user, or log in as a superuser with the following credentials: <br><br>

        email: <b>admin</b> <br>
        password: <b>admin</b> <br>
        <br>
        <p>
          <a class="btn btn-primary" href="{{ url_for('security.login') }}">Login</a> <a class="btn btn-default" href="{{ url_for('security.register') }}">Register</a>
        </p>
        {% endif %}
        <br>
        <p>
          <a class="btn btn-primary" href="/"><i class="glyphicon glyphicon-chevron-left"></i> Back</a>
        </p>
      </div>
    </section>
  </center>

  <br><br><br><br><br><br><br><br><br>
  <br><br><br><br><br><br><br><br><br><br>
  {% endif %}

  {% endblock body %}

  {% block tail %}
  <script>
    $(document).ready(function () {
      $('#dtBasicExample').DataTable({
       "paging": false, // false to disable pagination (or any other option)
       "order":[[6, "desc"]],
       "language":{
         "search":"",
         "searchPlaceholder":"Search. . ."
        }
        });
    $('.dataTables_length').addClass('bs-select');
  });
  </script>
  {% endblock tail %}
